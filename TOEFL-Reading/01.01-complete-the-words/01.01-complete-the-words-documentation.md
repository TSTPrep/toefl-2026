# TOEFL Reading - Complete the Words Generation Documentation

## Overview
This document provides a comprehensive analysis of the Google Sheets spreadsheet "TOEFL Reading - Complete the Words - Generation" and its associated Google Apps Script. The system is designed to generate "Complete the Words" exercises for TOEFL reading practice, using AI to automatically create passages with blanks.

The script has been refactored to be highly configurable, with all major parameters, topics, and even the AI prompt itself managed directly from the Google Sheet.

## Google Sheet Structure

### Spreadsheet Overview
- **Title**: TOEFL Reading - Complete the Words - Generation
- **ID**: 1mFFyQ9EsjIZQyq3fWJCSLc78aGaIAdXrFGclXvwcLHI
- **Purpose**: A fully configurable system for the automated generation of TOEFL "Complete the Words" reading exercises.

### Key Sheets

#### 1. Config (gid: 188417004)
**Purpose**: The central control panel for the entire script. All operational parameters and the AI prompt are defined here.

**Structure**:
- **Column A (Key)**: The name of the configuration variable (e.g., `MODEL`, `TEMPERATURE`, `API_KEY`).
- **Column B (Value)**: The value for the corresponding key.

**Key Configuration Variables**:
- **AI Model & Parameters**: `MODEL`, `TEMPERATURE`, `MAX_COMPLETION_TOKENS`, `API_KEY`, `OPENAI_URL`.
- **Passage Rules**: `PASSAGE_LENGTH_MIN`, `PASSAGE_LENGTH_MAX`, `BLANKS_COUNT`.
- **Dynamic AI Prompt**: The prompt sent to the AI is constructed from several cells in this sheet (`PROMPT_HEADER`, `PROMPT_REQUIREMENTS`, `PROMPT_CONSTRAINTS`, `PROMPT_FOOTER`), allowing for easy modification without touching the code.

#### 2. Topics (gid: 350240275)
**Purpose**: To manage the list of topics used for passage generation. This sheet allows for easy addition, removal, and categorization of topics.

**Structure**:
- **Column A (Category)**: The name of the topic category (e.g., "Natural Sciences & Environment").
- **Column B (Topics)**: A single cell containing a comma-separated list of all topics for that category, with each topic enclosed in double quotes.

#### 3. Output Sheet (e.g., 'Sheet1')
**Purpose**: This is where the generated passages are written. The script includes menu items to generate a single passage or a batch of passages, which will be written to the active sheet.

## Google Apps Script File

### `01.01-complete-the-words_PassageGenerator.gs`
**Primary Function**: The single, unified script that drives the entire passage generation process.

**Key Functions**:
- **`loadConfig()`**: Reads all key-value pairs from the 'Config' sheet and builds a configuration object.
- **`loadTopics()`**: Reads the topic categories and their corresponding topics from the 'Topics' sheet.
- **`buildPassagePrompt(topic)`**: Dynamically assembles the AI prompt using the components from the 'Config' sheet.
- **`generatePassageWithAI(topic)`**: Sends the final prompt to the OpenAI API and returns the generated passage.
- **`applyBlankingLogic(passage)`**: Takes the AI-generated passage and applies the specific blanking rules required for the exercise.
- **`generateSinglePassage()` & `generateBatchPassages()`**: Menu-driven functions to trigger the generation process.

## Overall Workflow

1.  **Configuration Loading**: When the script is run, the `loadConfig()` and `loadTopics()` functions are called. They read the latest settings and topic lists from the 'Config' and 'Topics' sheets.
2.  **Topic Selection**: The `getTopicFromSheet()` function selects a topic based on the mode specified in the sheet (e.g., random from a specific category, or a specific topic).
3.  **Prompt Generation**: The `buildPassagePrompt()` function constructs the AI prompt by assembling the different parts defined in the 'Config' sheet and inserting the selected topic.
4.  **AI Processing**: The script calls the OpenAI API with the dynamically generated prompt.
5.  **Blanking and Output**: The returned passage is processed by the `applyBlankingLogic()` function, which creates the blanks according to the defined rules. The final original and blanked passages are then written to the active sheet.

This configuration-driven approach makes the system highly flexible and easy to update. New topics, adjustments to the AI's instructions, and changes to parameters like passage length can all be managed directly from the Google Sheet without any code modifications.
